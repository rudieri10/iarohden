{% extends 'base.html' %}
{% block content %}

<!-- External Dependencies -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    * {
        box-sizing: border-box;
    }

    :root {
        --primary-blue: #2563eb;
        --primary-dark: #1d4ed8;
        --primary-light: #3b82f6;
        --accent-blue: #60a5fa;
        --soft-blue: #dbeafe;
        --chat-width: 600px;
        --history-width: 280px;
        --shadow-blue: rgba(37, 99, 235, 0.25);
    }

    main#mainContent {
        padding: 0 !important;
        overflow: hidden !important;
    }

    .page-wrapper {
        height: calc(100vh - var(--header-height, 70px));
        display: flex;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e8f0fe 100%);
        overflow: hidden;
        position: relative;
    }

    /* ═══════════════════════════════════════════════════════════
       DECORAÇÕES - ÍCONES DE IA/NEURAL
    ═══════════════════════════════════════════════════════════ */
    .ai-decoration {
        position: absolute;
        pointer-events: none;
        z-index: 0;
        opacity: 0.06;
    }

    .ai-decoration.dec1 {
        width: 200px;
        height: 200px;
        top: 5%;
        left: -30px;
        animation: floatRotate 20s ease-in-out infinite;
    }

    .ai-decoration.dec2 {
        width: 150px;
        height: 150px;
        bottom: 15%;
        left: 10%;
        animation: floatRotate 25s ease-in-out infinite reverse;
        opacity: 0.04;
    }

    .ai-decoration.dec3 {
        width: 120px;
        height: 120px;
        top: 35%;
        right: 320px;
        animation: floatRotate 18s ease-in-out infinite;
        opacity: 0.05;
    }

    .ai-decoration.dec4 {
        width: 100px;
        height: 100px;
        top: 70%;
        left: 25%;
        animation: floatRotate 22s ease-in-out infinite reverse;
        opacity: 0.03;
    }

    @keyframes floatRotate {
        0%, 100% { 
            transform: translateY(0) rotate(0deg) scale(1); 
        }
        25% {
            transform: translateY(-15px) rotate(5deg) scale(1.02);
        }
        50% { 
            transform: translateY(-25px) rotate(0deg) scale(1.05); 
        }
        75% {
            transform: translateY(-10px) rotate(-5deg) scale(1.02);
        }
    }

    /* Partículas */
    .particle {
        position: absolute;
        border-radius: 50%;
        pointer-events: none;
        z-index: 0;
    }

    .particle.p1 {
        width: 8px;
        height: 8px;
        background: var(--primary-blue);
        opacity: 0.15;
        top: 20%;
        left: 10%;
        animation: particleFloat 8s ease-in-out infinite;
    }

    .particle.p2 {
        width: 6px;
        height: 6px;
        background: var(--accent-blue);
        opacity: 0.2;
        top: 60%;
        left: 5%;
        animation: particleFloat 10s ease-in-out infinite reverse;
    }

    .particle.p3 {
        width: 10px;
        height: 10px;
        background: var(--primary-light);
        opacity: 0.1;
        top: 80%;
        left: 25%;
        animation: particleFloat 12s ease-in-out infinite;
    }

    .particle.p4 {
        width: 5px;
        height: 5px;
        background: var(--primary-dark);
        opacity: 0.15;
        top: 30%;
        left: 40%;
        animation: particleFloat 9s ease-in-out infinite reverse;
    }

    .particle.p5 {
        width: 7px;
        height: 7px;
        background: var(--accent-blue);
        opacity: 0.12;
        top: 50%;
        right: 350px;
        animation: particleFloat 11s ease-in-out infinite;
    }

    @keyframes particleFloat {
        0%, 100% { 
            transform: translateY(0) translateX(0); 
            opacity: 0.1;
        }
        50% { 
            transform: translateY(-30px) translateX(10px); 
            opacity: 0.2;
        }
    }

    /* Conexões neurais decorativas */
    .neural-line {
        position: absolute;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--primary-blue), transparent);
        opacity: 0.1;
        pointer-events: none;
        z-index: 0;
    }

    .neural-line.nl1 {
        width: 150px;
        top: 25%;
        left: 5%;
        transform: rotate(-20deg);
        animation: neuralPulse 3s ease-in-out infinite;
    }

    .neural-line.nl2 {
        width: 100px;
        top: 65%;
        left: 15%;
        transform: rotate(15deg);
        animation: neuralPulse 4s ease-in-out infinite reverse;
    }

    .neural-line.nl3 {
        width: 120px;
        top: 45%;
        left: 3%;
        transform: rotate(-5deg);
        animation: neuralPulse 5s ease-in-out infinite;
    }

    @keyframes neuralPulse {
        0%, 100% { opacity: 0.05; }
        50% { opacity: 0.15; }
    }

    /* ═══════════════════════════════════════════════════════════
       ÁREA PRINCIPAL
    ═══════════════════════════════════════════════════════════ */
    .main-area {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: stretch;
        padding: 30px 40px;
        position: relative;
        z-index: 1;
    }

    .chat-frame {
        width: 100%;
        max-width: var(--chat-width);
        display: flex;
        flex-direction: column;
        position: relative;
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        overflow: hidden;
        box-shadow: 
            0 8px 60px -15px var(--shadow-blue),
            0 0 0 1px rgba(255, 255, 255, 0.8),
            inset 0 0 80px -40px rgba(255, 255, 255, 0.8);
    }

    /* ═══════════════════════════════════════════════════════════
       ÁREA DE MENSAGENS
    ═══════════════════════════════════════════════════════════ */
    .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 28px 24px;
        display: flex;
        flex-direction: column;
    }

    .messages-container {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    /* Welcome */
    .welcome-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 40px 20px;
        animation: fadeInUp 0.6s ease-out;
    }

    .welcome-section.hidden {
        display: none;
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Logo IA animado */
    .welcome-logo {
        position: relative;
        width: 90px;
        height: 90px;
        margin-bottom: 24px;
    }

    .ai-brain-logo {
        width: 100%;
        height: 100%;
        filter: drop-shadow(0 8px 25px var(--shadow-blue));
        animation: brainPulse 3s ease-in-out infinite;
    }

    @keyframes brainPulse {
        0%, 100% { 
            transform: scale(1);
            filter: drop-shadow(0 8px 25px var(--shadow-blue));
        }
        50% { 
            transform: scale(1.05);
            filter: drop-shadow(0 12px 35px var(--shadow-blue));
        }
    }

    .welcome-title {
        font-size: 1.6rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 8px;
    }

    .welcome-title span {
        background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .welcome-subtitle {
        font-size: 0.9rem;
        color: #64748b;
        max-width: 320px;
        line-height: 1.5;
    }

    /* Lista de Mensagens */
    .msg-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .msg-row {
        display: flex;
        gap: 12px;
        animation: msgSlide 0.4s ease-out;
        max-width: 90%;
    }

    .msg-row.user {
        flex-direction: row-reverse;
        margin-left: auto;
    }

    .msg-row.ai {
        margin-right: auto;
    }

    @keyframes msgSlide {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .msg-avatar {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 0.9rem;
        font-weight: 600;
        overflow: hidden;
    }

    .msg-row.user .msg-avatar {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    }

    .msg-row.ai .msg-avatar {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
        color: #ffffff;
        box-shadow: 0 4px 15px var(--shadow-blue);
        padding: 6px;
    }

    .msg-row.ai .msg-avatar svg {
        width: 100%;
        height: 100%;
    }

    .msg-body {
        flex: 1;
        min-width: 0;
    }

    .msg-content {
        background: #ffffff;
        border-radius: 16px;
        padding: 12px 16px;
        color: #1e293b;
        font-size: 0.9rem;
        line-height: 1.65;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
        position: relative;
    }

    .msg-row.user .msg-content {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
        color: #ffffff;
        border-top-right-radius: 4px;
    }

    .msg-row.ai .msg-content {
        border-top-left-radius: 4px;
        padding-bottom: 40px;
    }

    .msg-content p { margin: 0 0 8px 0; }
    .msg-content p:last-child { margin-bottom: 0; }
    .msg-content ul, .msg-content ol { margin: 8px 0; padding-left: 20px; }
    .msg-content li { margin-bottom: 4px; }

    .msg-row.ai .msg-content code {
        background: var(--soft-blue);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Monaco', 'Consolas', monospace;
        font-size: 0.85em;
        color: var(--primary-dark);
    }

    .msg-row.user .msg-content code {
        background: rgba(255, 255, 255, 0.2);
        color: #ffffff;
    }

    .msg-content pre {
        background: #1e293b;
        border-radius: 10px;
        padding: 14px;
        overflow-x: auto;
        margin: 10px 0;
    }

    .msg-content pre code {
        background: none;
        padding: 0;
        color: #e2e8f0;
    }

    /* Botão Copiar na mensagem da IA */
    .msg-copy-btn {
        position: absolute;
        bottom: 10px;
        right: 12px;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        color: #64748b;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.75rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s ease;
        opacity: 0;
    }

    .msg-row.ai .msg-content:hover .msg-copy-btn {
        opacity: 1;
    }

    .msg-copy-btn:hover {
        background: var(--primary-blue);
        border-color: var(--primary-blue);
        color: white;
        transform: scale(1.05);
    }

    .msg-copy-btn.copied {
        background: #10b981;
        border-color: #10b981;
        color: white;
    }

    .msg-time {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 5px;
        margin-top: 5px;
        font-size: 0.7rem;
        color: #94a3b8;
    }

    .msg-row.user .msg-time { color: rgba(255, 255, 255, 0.6); }

    .msg-check {
        color: var(--accent-blue);
        font-size: 0.8rem;
    }

    /* ═══════════════════════════════════════════════════════════
       IA PENSANDO - ANIMAÇÃO ELABORADA
    ═══════════════════════════════════════════════════════════ */
    .ai-thinking {
        display: none;
        gap: 12px;
        margin-top: 16px;
        max-width: 90%;
        animation: msgSlide 0.4s ease-out;
    }

    .ai-thinking.visible {
        display: flex;
    }

    .ai-thinking-avatar {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        position: relative;
        box-shadow: 0 4px 15px var(--shadow-blue);
        animation: avatarGlow 2s ease-in-out infinite;
        padding: 6px;
        overflow: hidden;
    }

    @keyframes avatarGlow {
        0%, 100% { box-shadow: 0 4px 15px var(--shadow-blue); }
        50% { box-shadow: 0 4px 25px var(--shadow-blue), 0 0 30px rgba(37, 99, 235, 0.3); }
    }

    .ai-thinking-avatar svg {
        width: 100%;
        height: 100%;
        animation: thinkingBrain 2s ease-in-out infinite;
    }

    @keyframes thinkingBrain {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .ai-thinking-content {
        flex: 1;
        background: #ffffff;
        border-radius: 16px;
        border-top-left-radius: 4px;
        padding: 14px 18px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 14px;
    }

    .thinking-brain-icon {
        width: 32px;
        height: 32px;
        flex-shrink: 0;
        animation: thinkingPulse 1.5s ease-in-out infinite;
    }

    @keyframes thinkingPulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.8; }
    }

    .thinking-text-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .thinking-text {
        color: #475569;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .thinking-subtext {
        color: #94a3b8;
        font-size: 0.75rem;
        animation: textFade 2s ease-in-out infinite;
    }

    @keyframes textFade {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .thinking-wave {
        display: flex;
        gap: 3px;
        align-items: center;
    }

    .thinking-wave span {
        width: 3px;
        height: 16px;
        background: linear-gradient(180deg, var(--primary-blue), var(--accent-blue));
        border-radius: 2px;
        animation: wave 1s ease-in-out infinite;
    }

    .thinking-wave span:nth-child(1) { animation-delay: 0s; height: 12px; }
    .thinking-wave span:nth-child(2) { animation-delay: 0.1s; height: 18px; }
    .thinking-wave span:nth-child(3) { animation-delay: 0.2s; height: 14px; }
    .thinking-wave span:nth-child(4) { animation-delay: 0.3s; height: 20px; }
    .thinking-wave span:nth-child(5) { animation-delay: 0.4s; height: 16px; }

    @keyframes wave {
        0%, 100% { transform: scaleY(1); opacity: 0.5; }
        50% { transform: scaleY(1.5); opacity: 1; }
    }

    /* ═══════════════════════════════════════════════════════════
       ÁREA DE INPUT
    ═══════════════════════════════════════════════════════════ */
    .input-section {
        background: transparent;
        padding: 0 20px 20px 20px;
        flex-shrink: 0;
    }

    .input-box {
        background: #ffffff;
        border: 2px solid transparent;
        border-radius: 18px;
        padding: 12px 16px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 25px rgba(0, 0, 0, 0.06);
        position: relative;
        overflow: hidden;
    }

    .input-box::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 16px;
        padding: 2px;
        background: linear-gradient(135deg, var(--primary-blue), var(--accent-blue), var(--primary-light));
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .input-box:focus-within::before {
        opacity: 1;
    }

    .input-box:focus-within {
        box-shadow: 
            0 8px 40px var(--shadow-blue),
            0 0 0 4px rgba(37, 99, 235, 0.08);
        transform: translateY(-2px);
    }

    .input-field {
        background: transparent;
        border: none;
        outline: none;
        color: #1e293b;
        font-size: 0.9rem;
        line-height: 1.5;
        resize: none;
        max-height: 100px;
        font-family: inherit;
        width: 100%;
        position: relative;
        z-index: 1;
    }

    .input-field::placeholder {
        color: #94a3b8;
    }

    .input-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        position: relative;
        z-index: 1;
    }

    .input-tools {
        display: flex;
        gap: 4px;
    }

    .tool-btn {
        background: transparent;
        border: none;
        color: #94a3b8;
        width: 36px;
        height: 36px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        font-size: 1.05rem;
    }

    .tool-btn:hover {
        background: var(--soft-blue);
        color: var(--primary-blue);
        transform: scale(1.1);
    }

    .send-btn {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
        border: none;
        color: #ffffff;
        width: 42px;
        height: 42px;
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.25s ease;
        font-size: 1.1rem;
        box-shadow: 0 4px 15px var(--shadow-blue);
    }

    .send-btn:hover:not(:disabled) {
        transform: scale(1.08) rotate(-5deg);
        box-shadow: 0 6px 25px var(--shadow-blue);
    }

    .send-btn:active:not(:disabled) {
        transform: scale(0.95);
    }

    .send-btn:disabled {
        background: #e2e8f0;
        color: #94a3b8;
        cursor: not-allowed;
        box-shadow: none;
    }

    /* ═══════════════════════════════════════════════════════════
       SIDEBAR DE HISTÓRICO
    ═══════════════════════════════════════════════════════════ */
    .history-sidebar {
        width: var(--history-width);
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(20px);
        border-left: 1px solid rgba(255, 255, 255, 0.5);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        position: relative;
        z-index: 1;
        box-shadow: -10px 0 40px rgba(0, 0, 0, 0.03);
    }

    .sidebar-header {
        padding: 20px 16px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .sidebar-title {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #1e293b;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .sidebar-title i {
        color: var(--primary-blue);
        font-size: 1.1rem;
    }

    .new-chat-btn {
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
        border: none;
        color: white;
        width: 34px;
        height: 34px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.25s ease;
        font-size: 1rem;
        box-shadow: 0 3px 12px var(--shadow-blue);
    }

    .new-chat-btn:hover {
        transform: scale(1.1) rotate(90deg);
        box-shadow: 0 5px 20px var(--shadow-blue);
    }

    .sidebar-list {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
    }

    .history-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 14px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 6px;
        border: 1px solid transparent;
        position: relative;
        overflow: hidden;
    }

    .history-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 0;
        background: linear-gradient(180deg, var(--primary-blue), var(--primary-dark));
        transition: width 0.2s ease;
        border-radius: 0 4px 4px 0;
    }

    .history-item:hover {
        background: rgba(255, 255, 255, 0.8);
        border-color: rgba(0, 0, 0, 0.05);
    }

    .history-item:hover::before {
        width: 3px;
    }

    .history-item.active {
        background: var(--soft-blue);
        border-color: rgba(37, 99, 235, 0.2);
    }

    .history-item.active::before {
        width: 3px;
    }

    .history-item-icon {
        color: var(--primary-blue);
        font-size: 0.95rem;
        flex-shrink: 0;
        position: relative;
        z-index: 1;
    }

    .history-item-title {
        flex: 1;
        color: #475569;
        font-size: 0.85rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        position: relative;
        z-index: 1;
    }

    .history-item.active .history-item-title {
        color: var(--primary-dark);
        font-weight: 500;
    }

    .history-item-delete {
        opacity: 0;
        background: transparent;
        border: none;
        color: #94a3b8;
        cursor: pointer;
        padding: 4px 6px;
        border-radius: 6px;
        transition: all 0.2s ease;
        font-size: 0.85rem;
        position: relative;
        z-index: 1;
    }

    .history-item:hover .history-item-delete {
        opacity: 1;
    }

    .history-item-delete:hover {
        color: #dc2626;
        background: rgba(239, 68, 68, 0.1);
    }

    /* Empty State */
    .empty-history {
        text-align: center;
        padding: 50px 16px;
        color: #94a3b8;
    }

    .empty-history-icon {
        width: 50px;
        height: 50px;
        margin: 0 auto 16px;
        opacity: 0.3;
    }

    .empty-history p {
        font-size: 0.85rem;
        margin: 0;
    }

    /* Sidebar Actions */
    .sidebar-actions {
        padding: 12px;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        gap: 8px;
    }

    .sidebar-action-btn {
        flex: 1;
        background: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(0, 0, 0, 0.08);
        color: #64748b;
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .sidebar-action-btn:hover {
        background: var(--soft-blue);
        border-color: var(--primary-blue);
        color: var(--primary-blue);
    }

    .sidebar-action-btn.danger:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: #fca5a5;
        color: #dc2626;
    }

    /* Code Block */
    .code-block {
        background: #1e293b;
        border-radius: 10px;
        margin: 12px 0;
        overflow: hidden;
    }

    .code-block-header {
        background: #0f172a;
        padding: 8px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .code-block-header span {
        color: #94a3b8;
        font-size: 0.75rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .copy-btn {
        background: #334155;
        border: none;
        color: #94a3b8;
        padding: 4px 10px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.7rem;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .copy-btn:hover {
        background: #475569;
        color: #ffffff;
    }

    .code-block-body {
        padding: 12px;
        overflow-x: auto;
    }

    .code-block-body pre {
        margin: 0;
        background: transparent;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
        width: 5px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
    }

    /* Responsive */
    @media (max-width: 900px) {
        .history-sidebar {
            position: fixed;
            right: 0;
            top: var(--header-height, 70px);
            bottom: 0;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 100;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.15);
        }

        .history-sidebar.open {
            transform: translateX(0);
        }

        .sidebar-toggle-mobile {
            display: flex;
        }

        .main-area {
            padding: 20px 16px;
        }

        .ai-decoration.dec3,
        .ai-decoration.dec4 {
            display: none;
        }
    }

    @media (max-width: 600px) {
        :root {
            --chat-width: 100%;
        }

        .main-area {
            padding: 12px 8px;
        }

        .chat-frame {
            border-radius: 20px;
        }

        .messages-area {
            padding: 20px 16px;
        }

        .msg-row {
            max-width: 95%;
        }

        .msg-avatar {
            width: 34px;
            height: 34px;
            border-radius: 10px;
        }

        .msg-content {
            padding: 10px 12px;
            font-size: 0.85rem;
        }

        .msg-row.ai .msg-content {
            padding-bottom: 38px;
        }

        .msg-copy-btn {
            opacity: 1;
            padding: 5px 10px;
            font-size: 0.7rem;
        }

        .input-section {
            padding: 0 12px 14px 12px;
        }

        .welcome-logo {
            width: 75px;
            height: 75px;
        }

        .welcome-title {
            font-size: 1.4rem;
        }

        .ai-decoration {
            display: none;
        }
    }

    @media (hover: none) and (pointer: coarse) {
        .history-item-delete {
            opacity: 1;
        }

        .msg-copy-btn {
            opacity: 1;
        }

        .tool-btn,
        .send-btn {
            min-width: 44px;
            min-height: 44px;
        }
    }

    /* Mobile Toggle */
    .sidebar-toggle-mobile {
        display: none;
        position: fixed;
        right: 16px;
        bottom: 100px;
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
        border: none;
        border-radius: 50%;
        color: white;
        font-size: 1.2rem;
        cursor: pointer;
        z-index: 99;
        box-shadow: 0 4px 20px var(--shadow-blue);
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .sidebar-toggle-mobile:hover {
        transform: scale(1.1);
    }

    @media (max-width: 900px) {
        .sidebar-toggle-mobile {
            display: flex;
        }
    }

    /* Overlay mobile */
    .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(4px);
        z-index: 99;
    }

    .sidebar-overlay.visible {
        display: block;
    }
    .mode-toggle {
        display: flex;
        background: #e5e7eb;
        padding: 3px;
        border-radius: 20px;
        margin-right: 12px;
        border: none;
        position: relative;
        width: 180px;
        height: 36px;
    }

    .mode-btn {
        flex: 1;
        padding: 0;
        border-radius: 17px;
        border: none;
        background: transparent;
        color: #4b5563;
        font-size: 0.75rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        z-index: 2;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .mode-btn i {
        font-size: 0.85rem;
    }

    .mode-btn.active {
        color: var(--primary-blue);
    }

    /* Indicador deslizante */
    .mode-toggle::after {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: calc(50% - 3px);
        height: calc(100% - 6px);
        background: white;
        border-radius: 17px;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        z-index: 1;
    }

    .mode-toggle.agente-active::after {
        transform: translateX(100%);
    }

    .mode-btn:hover:not(.active) {
        color: #1f2937;
    }

    /* Ajuste para mobile */
    @media (max-width: 600px) {
        .mode-toggle {
            width: 140px;
            margin-right: 8px;
        }
        .mode-btn span {
            display: none;
        }
        .mode-btn {
            font-size: 0.7rem;
        }
    }
</style>

<!-- SVG Definitions -->
<svg style="position: absolute; width: 0; height: 0; overflow: hidden;">
    <defs>
        <!-- Gradiente para ícones -->
        <linearGradient id="aiGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#2563eb"/>
            <stop offset="50%" style="stop-color:#3b82f6"/>
            <stop offset="100%" style="stop-color:#1d4ed8"/>
        </linearGradient>
        
        <!-- Ícone de IA/Cérebro Neural detalhado -->
        <symbol id="aiBrainIcon" viewBox="0 0 100 100">
            <!-- Círculo externo -->
            <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="2" opacity="0.3"/>
            <!-- Cérebro estilizado -->
            <path d="M50 20 
                     C35 20 25 30 25 42 
                     C25 48 28 54 33 58 
                     C30 62 28 68 30 74 
                     C32 80 38 84 45 84 
                     C48 84 50 83 50 83
                     C50 83 52 84 55 84 
                     C62 84 68 80 70 74 
                     C72 68 70 62 67 58 
                     C72 54 75 48 75 42 
                     C75 30 65 20 50 20Z" 
                  fill="currentColor" opacity="0.9"/>
            <!-- Detalhes do cérebro - sulcos -->
            <path d="M38 35 Q45 40 52 35" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.6"/>
            <path d="M48 35 Q55 40 62 35" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.6"/>
            <path d="M35 48 Q42 52 50 48 Q58 44 65 48" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.6"/>
            <path d="M38 60 Q45 55 50 60 Q55 65 62 60" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.6"/>
            <!-- Pontos de conexão neural -->
            <circle cx="30" cy="35" r="3" fill="currentColor" opacity="0.7">
                <animate attributeName="opacity" values="0.4;1;0.4" dur="2s" repeatCount="indefinite"/>
            </circle>
            <circle cx="70" cy="35" r="3" fill="currentColor" opacity="0.7">
                <animate attributeName="opacity" values="0.4;1;0.4" dur="2s" repeatCount="indefinite" begin="0.3s"/>
            </circle>
            <circle cx="25" cy="55" r="3" fill="currentColor" opacity="0.7">
                <animate attributeName="opacity" values="0.4;1;0.4" dur="2s" repeatCount="indefinite" begin="0.6s"/>
            </circle>
            <circle cx="75" cy="55" r="3" fill="currentColor" opacity="0.7">
                <animate attributeName="opacity" values="0.4;1;0.4" dur="2s" repeatCount="indefinite" begin="0.9s"/>
            </circle>
            <!-- Linhas de conexão -->
            <line x1="30" y1="35" x2="38" y2="38" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                <animate attributeName="opacity" values="0.2;0.8;0.2" dur="1.5s" repeatCount="indefinite"/>
            </line>
            <line x1="70" y1="35" x2="62" y2="38" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                <animate attributeName="opacity" values="0.2;0.8;0.2" dur="1.5s" repeatCount="indefinite" begin="0.2s"/>
            </line>
            <line x1="25" y1="55" x2="33" y2="52" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                <animate attributeName="opacity" values="0.2;0.8;0.2" dur="1.5s" repeatCount="indefinite" begin="0.4s"/>
            </line>
            <line x1="75" y1="55" x2="67" y2="52" stroke="currentColor" stroke-width="1.5" opacity="0.5">
                <animate attributeName="opacity" values="0.2;0.8;0.2" dur="1.5s" repeatCount="indefinite" begin="0.6s"/>
            </line>
            <!-- Órbita animada -->
            <circle cx="50" cy="50" r="40" fill="none" stroke="currentColor" stroke-width="1" stroke-dasharray="5 10" opacity="0.3">
                <animateTransform attributeName="transform" type="rotate" from="0 50 50" to="360 50 50" dur="20s" repeatCount="indefinite"/>
            </circle>
        </symbol>

        <!-- Versão simplificada para avatar -->
        <symbol id="aiBrainSimple" viewBox="0 0 100 100">
            <path d="M50 15 
                     C30 15 18 28 18 45 
                     C18 55 24 63 32 68 
                     C28 74 28 82 35 88 
                     C42 94 50 90 50 90
                     C50 90 58 94 65 88 
                     C72 82 72 74 68 68 
                     C76 63 82 55 82 45 
                     C82 28 70 15 50 15Z" 
                  fill="white"/>
            <path d="M35 32 Q45 38 55 32" fill="none" stroke="rgba(37,99,235,0.5)" stroke-width="3" stroke-linecap="round"/>
            <path d="M45 32 Q55 38 65 32" fill="none" stroke="rgba(37,99,235,0.5)" stroke-width="3" stroke-linecap="round"/>
            <path d="M30 50 Q40 55 50 50 Q60 45 70 50" fill="none" stroke="rgba(37,99,235,0.5)" stroke-width="3" stroke-linecap="round"/>
            <path d="M35 68 Q45 62 50 68 Q55 74 65 68" fill="none" stroke="rgba(37,99,235,0.5)" stroke-width="3" stroke-linecap="round"/>
            <circle cx="22" cy="38" r="4" fill="white" opacity="0.8"/>
            <circle cx="78" cy="38" r="4" fill="white" opacity="0.8"/>
            <circle cx="18" cy="58" r="4" fill="white" opacity="0.8"/>
            <circle cx="82" cy="58" r="4" fill="white" opacity="0.8"/>
        </symbol>

        <!-- Ícone decorativo para fundo -->
        <symbol id="aiDecorationIcon" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="1"/>
            <circle cx="50" cy="50" r="35" fill="none" stroke="currentColor" stroke-width="0.5" stroke-dasharray="3 3"/>
            <circle cx="50" cy="50" r="25" fill="none" stroke="currentColor" stroke-width="0.5"/>
            <path d="M50 15 
                     C32 15 20 28 20 45 
                     C20 55 25 62 32 67 
                     C28 73 28 80 34 86 
                     C40 92 50 88 50 88
                     C50 88 60 92 66 86 
                     C72 80 72 73 68 67 
                     C75 62 80 55 80 45 
                     C80 28 68 15 50 15Z" 
                  fill="currentColor" opacity="0.3"/>
            <circle cx="20" cy="35" r="3" fill="currentColor" opacity="0.5"/>
            <circle cx="80" cy="35" r="3" fill="currentColor" opacity="0.5"/>
            <circle cx="15" cy="55" r="3" fill="currentColor" opacity="0.5"/>
            <circle cx="85" cy="55" r="3" fill="currentColor" opacity="0.5"/>
            <circle cx="30" cy="85" r="3" fill="currentColor" opacity="0.5"/>
            <circle cx="70" cy="85" r="3" fill="currentColor" opacity="0.5"/>
            <line x1="20" y1="35" x2="35" y2="40" stroke="currentColor" stroke-width="0.5" opacity="0.5"/>
            <line x1="80" y1="35" x2="65" y2="40" stroke="currentColor" stroke-width="0.5" opacity="0.5"/>
            <line x1="15" y1="55" x2="30" y2="52" stroke="currentColor" stroke-width="0.5" opacity="0.5"/>
            <line x1="85" y1="55" x2="70" y2="52" stroke="currentColor" stroke-width="0.5" opacity="0.5"/>
        </symbol>
    </defs>
</svg>

<div class="page-wrapper">
    <!-- Decorações de fundo -->
    <div class="ai-decoration dec1">
        <svg><use href="#aiDecorationIcon" fill="var(--primary-blue)"/></svg>
    </div>
    <div class="ai-decoration dec2">
        <svg><use href="#aiDecorationIcon" fill="var(--primary-blue)"/></svg>
    </div>
    <div class="ai-decoration dec3">
        <svg><use href="#aiDecorationIcon" fill="var(--primary-blue)"/></svg>
    </div>
    <div class="ai-decoration dec4">
        <svg><use href="#aiDecorationIcon" fill="var(--primary-blue)"/></svg>
    </div>

    <!-- Partículas -->
    <div class="particle p1"></div>
    <div class="particle p2"></div>
    <div class="particle p3"></div>
    <div class="particle p4"></div>
    <div class="particle p5"></div>

    <!-- Linhas neurais -->
    <div class="neural-line nl1"></div>
    <div class="neural-line nl2"></div>
    <div class="neural-line nl3"></div>

    <!-- Área Principal -->
    <div class="main-area">
        <div class="chat-frame">
            <!-- Área de Mensagens -->
            <div class="messages-area" id="messagesArea">
                <div class="messages-container">
                    <!-- Welcome -->
                    <div class="welcome-section" id="welcomeSection">
                        <div class="welcome-logo">
                            <svg class="ai-brain-logo" viewBox="0 0 100 100">
                                <use href="#aiBrainIcon" fill="var(--primary-blue)"/>
                            </svg>
                        </div>
                        <div class="welcome-title">Olá, <span>como posso ajudar?</span></div>
                        <div class="welcome-subtitle">Estou aqui para responder suas perguntas e auxiliar no que precisar.</div>
                    </div>

                    <!-- Lista de Mensagens -->
                    <div class="msg-list" id="msgList"></div>

                    <!-- IA Pensando -->
                    <div class="ai-thinking" id="aiThinking">
                        <div class="ai-thinking-avatar">
                            <svg viewBox="0 0 100 100">
                                <use href="#aiBrainSimple"/>
                            </svg>
                        </div>
                        <div class="ai-thinking-content">
                            <div class="thinking-wave">
                                <span></span>
                                <span></span>
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Área de Input -->
            <div class="input-section">
                <div class="input-box">
                    <textarea class="input-field" id="inputField" rows="1" placeholder="Digite sua mensagem..."></textarea>
                    <div class="input-actions">
                        <div class="input-tools">
                            <div class="mode-toggle" id="modeToggle">
                                <button class="mode-btn active" onclick="setChatMode('chat')" title="Modo Conversa">
                                    <i class="bi bi-chat-dots"></i>
                                    <span>Chat</span>
                                </button>
                                <button class="mode-btn" onclick="setChatMode('agente')" title="Modo Agente (Empresa)">
                                    <i class="bi bi-robot"></i>
                                    <span>Agente</span>
                                </button>
                            </div>
                            <button class="tool-btn" onclick="attachFile()" title="Anexar arquivo">
                                <i class="bi bi-paperclip"></i>
                            </button>
                            <button class="tool-btn" onclick="voiceInput()" title="Entrada por voz">
                                <i class="bi bi-mic"></i>
                            </button>
                        </div>
                        <button class="send-btn" id="sendBtn" disabled title="Enviar mensagem">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar de Histórico -->
    <div class="history-sidebar" id="historySidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">
                <i class="bi bi-clock-history"></i>
                Histórico
            </div>
            <button class="new-chat-btn" onclick="newChat()" title="Nova conversa">
                <i class="bi bi-plus"></i>
            </button>
        </div>
        <div class="sidebar-list" id="sidebarList">
            <div class="empty-history" id="emptyHistory">
                <svg class="empty-history-icon" viewBox="0 0 100 100">
                    <use href="#aiBrainIcon" fill="var(--primary-blue)"/>
                </svg>
                <p>Nenhuma conversa ainda</p>
            </div>
        </div>
        <div class="sidebar-actions">
            <button class="sidebar-action-btn danger" onclick="clearAll()">
                <i class="bi bi-trash3"></i>
                Limpar
            </button>
        </div>
    </div>

    <!-- Toggle Mobile -->
    <button class="sidebar-toggle-mobile" id="sidebarToggle" onclick="toggleSidebar()">
        <i class="bi bi-clock-history"></i>
    </button>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    marked.setOptions({
        highlight: function(code, lang) {
            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
            return hljs.highlight(code, { language }).value;
        },
        langPrefix: 'hljs language-',
        headerIds: false,
        gfm: true,
        breaks: true
    });

    const inputField = document.getElementById('inputField');
    const sendBtn = document.getElementById('sendBtn');
    const messagesArea = document.getElementById('messagesArea');
    const welcomeSection = document.getElementById('welcomeSection');
    const msgList = document.getElementById('msgList');
    const aiThinking = document.getElementById('aiThinking');
    const sidebarList = document.getElementById('sidebarList');
    const historySidebar = document.getElementById('historySidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    let currentMode = 'chat';
    let chatId = null;
    let history = [];
    let processing = false;
    let hasMessages = false;

    // Mode Selector
    window.setChatMode = function(mode) {
        currentMode = mode;
        const toggle = document.getElementById('modeToggle');
        const btns = document.querySelectorAll('.mode-btn');
        
        if (mode === 'agente') {
            toggle.classList.add('agente-active');
        } else {
            toggle.classList.remove('agente-active');
        }

        btns.forEach(btn => {
            if (btn.getAttribute('onclick').includes(`'${mode}'`)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        // Update placeholder based on mode
        inputField.placeholder = mode === 'chat' 
            ? 'Converse com o Samuca...' 
            : 'Pergunte sobre dados da empresa (Modo Agente)...';
    };

    // Load history
    loadHistoryList();

    // Auto resize
    inputField.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        sendBtn.disabled = !this.value.trim();
    });

    // Enter to send
    inputField.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendBtn.disabled) sendMessage();
        }
    });

    sendBtn.addEventListener('click', sendMessage);

    // Send message
    async function sendMessage() {
        const msg = inputField.value.trim();
        if (!msg || processing) return;

        processing = true;

        if (!chatId) {
            try {
                const r = await fetch('{{ url_for("rohden_ai_chat_bp.new_chat") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: msg.substring(0, 30) })
                });
                chatId = (await r.json()).chat_id;
                loadHistoryList();
            } catch (e) { console.error(e); }
        }

        addMessage(msg, true);
        inputField.value = '';
        inputField.style.height = 'auto';
        sendBtn.disabled = true;

        aiThinking.classList.add('visible');
        scrollToBottom();

        try {
            const r = await fetch('{{ url_for("rohden_ai_chat_bp.ask") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    prompt: msg, 
                    chat_id: chatId, 
                    history: history,
                    mode: currentMode 
                })
            });
            const data = await r.json();
            aiThinking.classList.remove('visible');
            addMessage(data.error ? `**Erro:** ${data.error}` : data.response, false);
        } catch (e) {
            aiThinking.classList.remove('visible');
            addMessage('Erro ao processar.', false);
        } finally {
            processing = false;
        }
    }

    // Add message
    function addMessage(content, isUser) {
        if (!hasMessages) {
            welcomeSection.classList.add('hidden');
            hasMessages = true;
        }

        let text = content;
        let sqlHtml = '';

        const sqlMatch = text.match(/\[SQL\](.*?)\[\/SQL\]/si);
        if (sqlMatch) {
            const sql = sqlMatch[1].trim();
            text = text.replace(/\[SQL\].*?\[\/SQL\]/si, '');
            sqlHtml = `
                <div class="code-block">
                    <div class="code-block-header">
                        <span><i class="bi bi-database"></i> SQL</span>
                        <button class="copy-btn" onclick="copyText(\`${sql.replace(/`/g, '\\`')}\`)">
                            <i class="bi bi-copy"></i> Copiar
                        </button>
                    </div>
                    <div class="code-block-body">
                        <pre><code class="language-sql">${hljs.highlight(sql, {language: 'sql'}).value}</code></pre>
                    </div>
                </div>
            `;
        }

        text = text.replace(/\[SUGGESTIONS\].*?\[\/SUGGESTIONS\]/si, '');
        text = text.replace(/\[PREDICTION\].*?\[\/PREDICTION\]/si, '');

        const now = new Date();
        const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        const msgId = 'msg-' + Date.now();

        const row = document.createElement('div');
        row.className = `msg-row ${isUser ? 'user' : 'ai'}`;
        
        // Avatar HTML
        const avatarHtml = isUser 
            ? '<i class="bi bi-person-fill"></i>'
            : '<svg viewBox="0 0 100 100"><use href="#aiBrainSimple"/></svg>';

        // Botão copiar (só para mensagens da IA)
        const copyBtnHtml = !isUser 
            ? `<button class="msg-copy-btn" onclick="copyMsgContent('${msgId}', this)">
                   <i class="bi bi-copy"></i> Copiar
               </button>`
            : '';

        row.innerHTML = `
            <div class="msg-avatar">${avatarHtml}</div>
            <div class="msg-body">
                <div class="msg-content" id="${msgId}">
                    <div class="msg-text-content">${marked.parse(text)}</div>
                    ${sqlHtml}
                    ${copyBtnHtml}
                </div>
                <div class="msg-time">
                    <span>${timeStr}</span>
                    ${isUser ? '<i class="bi bi-check2-all msg-check"></i>' : ''}
                </div>
            </div>
        `;

        msgList.appendChild(row);
        scrollToBottom();
        history.push({ role: isUser ? 'user' : 'assistant', content: content });
    }

    function scrollToBottom() {
        setTimeout(() => {
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }, 50);
    }

    // Copy message content
    window.copyMsgContent = function(msgId, btn) {
        const msgEl = document.getElementById(msgId);
        const textContent = msgEl.querySelector('.msg-text-content');
        const text = textContent.innerText || textContent.textContent;
        
        navigator.clipboard.writeText(text).then(() => {
            btn.classList.add('copied');
            btn.innerHTML = '<i class="bi bi-check2"></i> Copiado!';
            
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = '<i class="bi bi-copy"></i> Copiar';
            }, 2000);
        });
    };

    // Load history list
    async function loadHistoryList() {
        try {
            const r = await fetch('{{ url_for("rohden_ai_chat_bp.list_chats") }}');
            const chats = await r.json();

            if (chats.length === 0) {
                sidebarList.innerHTML = `
                    <div class="empty-history">
                        <svg class="empty-history-icon" viewBox="0 0 100 100">
                            <use href="#aiBrainIcon" fill="var(--primary-blue)"/>
                        </svg>
                        <p>Nenhuma conversa ainda</p>
                    </div>
                `;
                return;
            }

            sidebarList.innerHTML = chats.map(c => `
                <div class="history-item ${c.id === chatId ? 'active' : ''}" onclick="loadChat(${c.id})">
                    <i class="bi bi-chat-text history-item-icon"></i>
                    <span class="history-item-title">${c.title}</span>
                    <button class="history-item-delete" onclick="deleteChat(${c.id}, event)">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            `).join('');
        } catch (e) { console.error(e); }
    }

    // Load chat
    window.loadChat = async function(id) {
        chatId = id;
        history = [];
        hasMessages = false;

        welcomeSection.classList.remove('hidden');
        msgList.innerHTML = '';

        if (window.innerWidth <= 900) {
            toggleSidebar();
        }

        try {
            const r = await fetch(`/rohden_ai/chat/chats/${id}`);
            const msgs = await r.json();
            msgs.forEach(m => addMessage(m.content, m.role === 'user'));
            loadHistoryList();
        } catch (e) { console.error(e); }
    };

    // New chat
    window.newChat = function() {
        chatId = null;
        history = [];
        hasMessages = false;
        welcomeSection.classList.remove('hidden');
        msgList.innerHTML = '';
        loadHistoryList();
        inputField.focus();
    };

    // Delete chat
    window.deleteChat = async function(id, e) {
        e.stopPropagation();

        const result = await Swal.fire({
            title: 'Excluir conversa?',
            text: 'Esta ação não pode ser desfeita.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            cancelButtonColor: '#64748b',
            confirmButtonText: 'Excluir',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            try {
                await fetch(`/rohden_ai/chat/chats/${id}`, { method: 'DELETE' });
                if (chatId === id) newChat();
                loadHistoryList();
            } catch (e) { console.error(e); }
        }
    };

    // Toggle sidebar (mobile)
    window.toggleSidebar = function() {
        historySidebar.classList.toggle('open');
        sidebarOverlay.classList.toggle('visible');
    };

    // Select mode
    window.selectMode = function() {
        Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'Em desenvolvimento', showConfirmButton: false, timer: 1500 });
    };

    // Clear all
    window.clearAll = async function() {
        const result = await Swal.fire({
            title: 'Limpar tudo?',
            text: 'Todas as conversas serão excluídas.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc2626',
            cancelButtonColor: '#64748b',
            confirmButtonText: 'Limpar',
            cancelButtonText: 'Cancelar'
        });

        if (result.isConfirmed) {
            Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Histórico limpo!', showConfirmButton: false, timer: 1500 });
        }
    };

    // Copy text
    window.copyText = function(t) {
        navigator.clipboard.writeText(t).then(() => {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Copiado!',
                showConfirmButton: false,
                timer: 1500
            });
        });
    };

    // Placeholders
    window.attachFile = function() {
        Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'Em desenvolvimento', showConfirmButton: false, timer: 1500 });
    };

    window.voiceInput = function() {
        Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'Em desenvolvimento', showConfirmButton: false, timer: 1500 });
    };
});
</script>

{% endblock %}