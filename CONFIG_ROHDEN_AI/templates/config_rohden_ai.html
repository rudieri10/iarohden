{% extends 'base.html' %}
{% block content %}

<style>
    :root {
        --primary-color: #2c3e50;
        --accent-color: #3498db;
    }
    
    body {
        background-color: #f8f9fa;
    }

    .container-fluid {
        padding-left: 15px !important;
        padding-right: 15px !important;
        max-width: 100%; /* Ocupar toda a tela */
    }

    .tables-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); /* Grid responsivo mais denso */
        gap: 15px;
        padding: 10px 0;
    }

    .main-header-config {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .nav-tabs .nav-link {
        border: none;
        background: #f8f9fa;
        color: #6c757d;
        padding: 12px 24px;
        margin-right: 8px;
        border-radius: 10px 10px 0 0;
        font-weight: 500;
        transition: all 0.3s;
    }
    
    .nav-tabs .nav-link.active {
        background: linear-gradient(135deg, #0066cc 0%, #004080 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3);
    }
    
    .nav-tabs .nav-link:hover {
        background: #e9ecef;
        transform: translateY(-2px);
    }
    
    .nav-tabs .nav-link.active:hover {
        background: linear-gradient(135deg, #0052a3 0%, #003366 100%);
    }
    
    .tab-content {
        background: white;
        border-radius: 0 15px 15px 15px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        padding: 2rem;
        min-height: 500px;
    }
    
    .table-card {
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 12px;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 100%;
    }

    .table-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }

    .trained-row {
        background-color: #f0fff4 !important; /* Verde ultra claro */
        border-left: 4px solid #28a745;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
    }

    .table-name {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 1.05rem;
        word-break: break-all;
    }

    .table-meta {
        font-size: 0.8rem;
        color: #6c757d;
    }
    
    .table-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .x-small-badge {
        font-size: 0.65rem;
        padding: 2px 6px;
    }
    
    .status-trained {
        background: #d4edda;
        color: #155724;
    }
    
    .status-pending {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-processing {
        background: #cce7ff;
        color: #004085;
    }
    
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 12px;
        padding: 3rem;
        text-align: center;
        transition: all 0.3s;
        background: #f8f9fa;
    }
    
    .upload-area:hover {
        border-color: #0066cc;
        background: #f0f4ff;
    }
    
    .upload-area.dragover {
        border-color: #0066cc;
        background: #e8f0ff;
        transform: scale(1.02);
    }
    
    .stats-card {
        background: linear-gradient(135deg, #0066cc 0%, #004080 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3);
    }
    
    .stats-number {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }
    
    .stats-label {
        opacity: 0.9;
        font-size: 0.9rem;
    }
    
    .btn-train {
        padding: 4px 12px;
        font-size: 0.85rem;
        font-weight: 600;
        width: 100%;
        margin-top: 10px;
    }
    
    .file-upload {
        display: none;
    }
    
    .upload-icon {
        font-size: 3rem;
        color: #0066cc;
        margin-bottom: 1rem;
    }

    .spinner-border {
        width: 1.5rem;
        height: 1.5rem;
    }

    .loading-container {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .nav-tabs-sm .nav-link {
        padding: 6px 12px;
        font-size: 0.85rem;
    }

    .trained-row {
        background-color: #d4edda !important; /* Verde claro */
        transition: background-color 0.5s ease;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
    }
    .loading-spinner {
        width: 3rem;
        height: 3rem;
        margin-bottom: 1rem;
    }
.x-small-table {
            font-size: 0.7rem !important;
        }
        .x-small-table td {
            padding: 2px 5px !important;
        }
        .markdown-body h6:first-child {
            margin-top: 0 !important;
        }
        
        .ai-data-card {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: 1px solid #eef2f7;
            background: #fff;
            transition: transform 0.2s;
        }
        
        .ai-data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        
        .ai-data-header {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f2f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .ai-data-body {
            padding: 20px;
        }
        
        .badge-pattern {
            background-color: #f1f8ff;
            color: #0366d6;
            border: 1px solid #c8e1ff;
            font-size: 0.75rem;
            margin-right: 5px;
            margin-bottom: 5px;
            padding: 4px 8px;
            border-radius: 6px;
            display: inline-block;
        }
        
        .flow-step {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .flow-step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #0066cc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .flow-arrow {
            width: 2px;
            height: 20px;
            background: #e1e4e8;
            margin-left: 14px;
            margin-top: -5px;
            margin-bottom: 5px;
        }
    </style>

<!-- Overlay de Carregamento -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner-border text-primary loading-spinner" role="status"></div>
    <h4 id="loadingMessage">Treinamento iniciado...</h4>
    <div class="w-50 mt-3">
        <div class="progress" style="height: 20px; border-radius: 10px;">
            <div id="trainingProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
        </div>
        <div class="d-flex justify-content-between mt-2">
            <small id="trainingStatus" class="text-muted">Iniciando an√°lise...</small>
            <small id="trainingTime" class="text-primary fw-bold"></small>
        </div>
    </div>
    <p class="text-muted mt-3">A IA est√° realizando a an√°lise avan√ßada da tabela e gerando padr√µes sem√¢nticos.</p>
</div>

<div class="container-fluid px-4 py-4">
    <div class="main-header-config text-white">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div class="main-icon d-flex align-items-center justify-content-center me-3"
                     style="width: 60px; height: 60px; background: rgba(255,255,255,0.2);
                            border-radius: 15px; backdrop-filter: blur(5px);">
                    <i class="bi bi-cpu-fill fs-2 text-white"></i>
                </div>
                <div>
                    <h1 class="fw-bold mb-1 fs-2">ROHDEN IA</h1>
                    <p class="mb-0 text-white-50">Treine a intelig√™ncia artificial com dados reais da empresa</p>
                </div>
            </div>
            <div class="text-end">
                <div class="fs-4 fw-bold">Rohden AI</div>
                <div class="text-white-50 small">Sistema Inteligente</div>
            </div>
        </div>
    </div>

    <!-- Abas de Navega√ß√£o -->
    <ul class="nav nav-tabs" id="trainingTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="training-tab" data-bs-toggle="tab" data-bs-target="#training" type="button" role="tab">
                <i class="bi bi-cpu me-2"></i>Treinamento
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">
                <i class="bi bi-database me-2"></i>Dados da IA
            </button>
        </li>
    </ul>

    <!-- Conte√∫do das Abas -->
    <div class="tab-content" id="trainingTabContent">
        
        <!-- Aba 1: Treinamento (Planilha + Banco) -->
        <div class="tab-pane fade show active" id="training" role="tabpanel">
            <div class="row">
                <!-- Se√ß√£o de Banco de Dados -->
                <div class="col-lg-6">
                    <div class="card border-0 mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-database me-2"></i>Banco de Dados
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Sele√ß√£o de Schema -->
                            <div class="mb-3">
                                <label class="form-label fw-bold">Schema</label>
                                <select class="form-select" id="schemaSelect" onchange="loadTablesForSchema()">
                                    <option value="">Carregando schemas...</option>
                                </select>
                            </div>
                            
                            <!-- Tabs para Tabelas Treinadas e N√£o Treinadas -->
                            <ul class="nav nav-tabs nav-tabs-sm mb-3" id="tableTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="untrained-tab" data-bs-toggle="tab" data-bs-target="#untrained" type="button" role="tab">
                                        <i class="bi bi-clock me-1"></i>Para Treinar
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="trained-tab" data-bs-toggle="tab" data-bs-target="#trained" type="button" role="tab">
                                        <i class="bi bi-check-circle me-1"></i>Treinadas
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- Conte√∫do das Tabs -->
                            <div class="tab-content" id="tableTabContent">
                                <!-- Tabelas N√£o Treinadas -->
                                <div class="tab-pane fade show active" id="untrained" role="tabpanel">
                                    <div class="mb-3">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-light border-end-0">
                                                <i class="bi bi-search"></i>
                                            </span>
                                            <input type="text" id="searchUntrained" class="form-control border-start-0" 
                                                   placeholder="Pesquisar tabela..." onkeyup="filterUntrainedTables()">
                                        </div>
                                    </div>
                                    <div id="untrainedTablesList" class="tables-grid" style="max-height: 500px; overflow-y: auto;">
                                        <div class="loading-container">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            <span class="ms-2">Carregando tabelas dispon√≠veis...</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabelas Treinadas -->
                                <div class="tab-pane fade" id="trained" role="tabpanel">
                                    <div class="mb-3">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text bg-light border-end-0">
                                                <i class="bi bi-search"></i>
                                            </span>
                                            <input type="text" id="searchTrained" class="form-control border-start-0" 
                                                   placeholder="Pesquisar tabela treinada..." onkeyup="filterTrainedTables()">
                                        </div>
                                    </div>
                                    <div id="trainedTablesList" class="tables-grid" style="max-height: 500px; overflow-y: auto;">
                                        <div class="loading-container">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            <span class="ms-2">Carregando tabelas treinadas...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Se√ß√£o de Planilha -->
                <div class="col-lg-6">
                    <div class="card border-0 mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-file-earmark-excel me-2"></i>Planilha
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="upload-area" id="uploadArea" style="padding: 2rem;">
                                <div class="upload-icon">
                                    <i class="bi bi-cloud-upload"></i>
                                </div>
                                <h6 class="mb-2">Arraste sua planilha aqui</h6>
                                <p class="text-muted mb-2 small">ou clique para selecionar</p>
                                <p class="text-muted small">.xlsx, .xls, .csv (m√°x. 10MB)</p>
                                <input type="file" id="fileInput" class="file-upload" accept=".xlsx,.xls,.csv">
                                <button class="btn btn-success btn-sm" onclick="document.getElementById('fileInput').click()">
                                    <i class="bi bi-upload me-1"></i>Selecionar
                                </button>
                            </div>
                            
                            <div id="uploadProgress" class="d-none mt-3">
                                <h6 class="mb-2">Processando...</h6>
                                <div class="progress mb-2">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                         role="progressbar" style="width: 0%" id="progressBar"></div>
                                </div>
                                <div id="uploadStatus" class="text-muted small"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            

        </div>

        <!-- Aba 2: Dados da IA (Relat√≥rios) -->
        <div class="tab-pane fade" id="data" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="fw-bold text-dark mb-0">
                    <i class="bi bi-graph-up me-2 text-primary"></i>
                    Relat√≥rios da IA
                </h3>
                <div class="d-flex align-items-center" style="min-width: 300px;">
                    <label class="form-label me-2 mb-0 fw-bold">Fonte:</label>
                    <select class="form-select" id="aiDataSourceSelect" onchange="renderAIData()">
                        <option value="all">Vis√£o Geral do C√©rebro</option>
                    </select>
                </div>
            </div>
            
            <div id="aiDataContent">
                <div class="row" id="summaryContent">
                    <div class="loading-container">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <span class="ms-2">Carregando dados da IA...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts Adicionais -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
    let trainedTables = [];
    let uploadedFiles = [];
    let trainingStats = {};
    let availableSchemas = [];
    let currentSchema = '';
    let allOracleTables = [];
    let cachedAIData = null;

    // Inicializa√ß√£o quando a p√°gina carrega
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Inicializando sistema...');
        loadSchemas();
        loadTables();
        loadTrainingStats();
        setupUploadArea();
        syncTrainingStatus(); // Novo: Sincronizar treinamentos em curso
        
        // Listener para aba de Dados da IA
        const dataTab = document.getElementById('data-tab');
        if (dataTab) {
            dataTab.addEventListener('click', function() {
                cachedAIData = null; // For√ßar recarregamento limpando cache local
                loadAIData();
            });
        }
    });

    // Novo: Sincronizar status de treinamentos do servidor
    async function syncTrainingStatus() {
        try {
            const response = await fetch('/config_rohden_ai/training_status');
            const status = await response.json();
            
            // Mesclar com o mapa local
            Object.assign(trainingStatusMap, status);
            
            // Se houver algum treinamento ativo, iniciar o monitor
            const hasActive = Object.values(trainingStatusMap).some(t => !t.done);
            if (hasActive) {
                console.log('Detectados treinamentos ativos no servidor, iniciando monitor...');
                startGlobalTrainingMonitor();
            }
        } catch (error) {
            console.error('Erro ao sincronizar status de treinamento:', error);
        }
    }

    async function loadAIData() {
        const container = document.getElementById('summaryContent');
        const select = document.getElementById('aiDataSourceSelect');
        
        container.innerHTML = `
            <div class="loading-container w-100">
                <div class="spinner-border text-primary" role="status"></div>
                <span class="ms-2">Consultando c√©rebro da IA...</span>
            </div>
        `;

        try {
            // Adicionar timestamp para evitar cache do navegador
            const response = await fetch(`/config_rohden_ai/get_ai_data?t=${new Date().getTime()}`);
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Erro HTTP ${response.status}: ${errorText.substring(0, 100)}`);
            }

            const data = await response.json();
            
            if (data.error) throw new Error(data.error);
            
            cachedAIData = data;

            // Popular o select com as tabelas treinadas que possuem dados
            const currentValue = select.value;
            select.innerHTML = '<option value="all">üß† Vis√£o Geral do C√©rebro</option>';
            
            // Filtrar apenas tabelas que possuem dados
            const validTables = (data.tables || []).filter(t => t.record_count > 0);
            
            validTables.forEach(table => {
                const option = document.createElement('option');
                option.value = table.table_name;
                option.textContent = `üìä Tabela: ${table.table_name}`;
                select.appendChild(option);
            });
            
            // Manter a sele√ß√£o se ela ainda existir
            if (Array.from(select.options).some(opt => opt.value === currentValue)) {
                select.value = currentValue;
            }

            renderAIData();
        } catch (error) {
            console.error('Erro ao carregar dados da IA:', error);
            container.innerHTML = `
                <div class="alert alert-danger mx-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Erro ao carregar dados do c√©rebro da IA: ${error.message}
                </div>
            `;
        }
    }

    function renderAIData() {
        if (!cachedAIData) return;
        
        const container = document.getElementById('summaryContent');
        const selectedTable = document.getElementById('aiDataSourceSelect').value;
        const data = cachedAIData;
        let html = '';

        if (selectedTable === 'all') {
            // 1. Resumo Geral
            html += `
                <div class="col-12 mb-4">
                    <div class="card border-0 shadow-sm overflow-hidden" style="border-radius: 15px;">
                        <div class="card-body p-0">
                            <div class="bg-primary text-white p-4">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h4 class="fw-bold mb-1">C√©rebro Digital Rohden</h4>
                                        <p class="mb-0 opacity-75">Estado atual do aprendizado consolidado</p>
                                    </div>
                                    <i class="bi bi-cpu fs-1 opacity-25"></i>
                                </div>
                            </div>
                            <div class="p-4 bg-white">
                                <div class="row g-4 text-center">
                                    <div class="col-md-3">
                                        <div class="p-3 rounded bg-light border">
                                            <div class="fs-3 fw-bold text-primary">${data.stats.total_tables}</div>
                                            <div class="small text-muted text-uppercase fw-bold">Fontes de Dados</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="p-3 rounded bg-light border">
                                            <div class="fs-3 fw-bold text-success">${data.stats.total_patterns}</div>
                                            <div class="small text-muted text-uppercase fw-bold">Padr√µes Ativos</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="p-3 rounded bg-light border">
                                            <div class="fs-3 fw-bold text-info">${data.stats.total_flows}</div>
                                            <div class="small text-muted text-uppercase fw-bold">Fluxos Mapeados</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="p-3 rounded bg-light border">
                                            <div class="fs-3 fw-bold text-warning">${data.knowledge ? data.knowledge.length : 0}</div>
                                            <div class="small text-muted text-uppercase fw-bold">Itens de Base</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 2. Coluna da Esquerda: Padr√µes Comportamentais
            html += '<div class="col-lg-7">';
            
            html += '<div class="d-flex justify-content-between align-items-center mb-3">';
            html += '<h5 class="fw-bold mb-0"><i class="bi bi-robot me-2 text-primary"></i>Padr√µes de Resposta da IA</h5>';
            html += `<span class="badge bg-light text-dark border">${data.patterns.length} padr√µes</span>`;
            html += '</div>';

            html += '<div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;"><div class="card-body p-0">';
            html += '<div class="list-group list-group-flush">';
            
            if (data.patterns.length === 0) {
                html += '<div class="p-4 text-center text-muted">Nenhum padr√£o sint√©tico gerado ainda.</div>';
            }
            
            data.patterns.slice(0, 30).forEach((p, idx) => {
                const isSuccess = p.success_indicator === 'SUCCESS' || p.success_count > 0;
                const indicatorClass = isSuccess ? 'bg-success' : 'bg-warning';
                const indicatorText = isSuccess ? 'Vetorizado' : 'Pendente';
                
                html += `
                    <div class="list-group-item p-3 border-0 border-bottom">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="fw-bold text-dark small" style="max-width: 80%;">
                                <i class="bi bi-chat-left-text me-2 text-primary opacity-50"></i>${p.user_input}
                            </div>
                            <span class="badge ${indicatorClass} x-small-badge">${indicatorText}</span>
                        </div>
                        <div class="p-2 bg-light rounded small text-muted mb-2" id="pattern-res-${idx}" style="border-left: 3px solid #dee2e6;">
                            ${(p.ai_response || '').substring(0, 120)}${(p.ai_response || '').length > 120 ? '...' : ''}
                        </div>
                        ${(p.ai_response || '').length > 120 ? `
                            <button class="btn btn-link btn-sm p-0 text-decoration-none x-small mb-2" 
                                    onclick="toggleFullPattern(${idx}, '${btoa(p.ai_response || '')}')" id="btn-pattern-${idx}">
                                <i class="bi bi-plus-circle me-1"></i>Ver resposta completa
                            </button>
                        ` : ''}
                        <div class="d-flex flex-wrap gap-1">
                            <span class="badge-pattern">${p.category || 'Geral'}</span>
                            ${p.tags ? p.tags.split(',').map(t => `<span class="badge-pattern bg-white border">${t.trim()}</span>`).join('') : ''}
                        </div>
                    </div>
                `;
            });
            
            if (data.patterns.length > 30) {
                html += `
                    <div class="p-3 text-center bg-light">
                        <small class="text-primary fw-bold">E mais ${data.patterns.length - 30} padr√µes ativos no c√©rebro</small>
                    </div>
                `;
            }
            
            html += '</div></div></div>';
            html += '</div>';

            // 3. Coluna da Direita: Fluxos e Conhecimento
            html += '<div class="col-lg-5">';
            
            // Fluxos de Neg√≥cio
            html += '<h5 class="fw-bold mb-3"><i class="bi bi-diagram-3 me-2 text-info"></i>Fluxos de Neg√≥cio</h5>';
            html += '<div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;"><div class="card-body p-3">';
            
            if (data.flows.length === 0) {
                html += '<p class="text-muted small text-center py-3">Nenhum fluxo inter-tabelas detectado.</p>';
            }
            
            data.flows.forEach(flow => {
                const sequence = Array.isArray(flow.flow_sequence) ? flow.flow_sequence : (typeof flow.flow_sequence === 'string' ? JSON.parse(flow.flow_sequence) : []);
                html += `
                    <div class="mb-4 p-3 rounded border shadow-xs bg-white">
                        <div class="fw-bold text-primary mb-3 d-flex align-items-center">
                            <i class="bi bi-lightning-fill me-2 text-warning"></i>${flow.process_name}
                        </div>
                        <div class="ps-2">
                            ${sequence.map((step, idx) => `
                                <div class="flow-step">
                                    <div class="flow-step-icon">${idx + 1}</div>
                                    <div class="small fw-bold text-dark">${step}</div>
                                </div>
                                ${idx < sequence.length - 1 ? '<div class="flow-arrow"></div>' : ''}
                            `).join('')}
                        </div>
                        ${flow.description ? `<div class="mt-3 small text-muted border-top pt-2 italic"><i class="bi bi-info-circle me-1"></i>${flow.description}</div>` : ''}
                    </div>
                `;
            });
            html += '</div></div>';

            // Base de Conhecimento
            html += '<h5 class="fw-bold mb-3"><i class="bi bi-journal-text me-2 text-warning"></i>Base de Conhecimento</h5>';
            html += '<div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;"><div class="card-body p-3">';
            
            if (!data.knowledge || data.knowledge.length === 0) {
                html += '<p class="text-muted small text-center py-3">Nenhum conhecimento manual cadastrado.</p>';
            } else {
                data.knowledge.forEach(k => {
                    html += `
                        <div class="mb-3 pb-2 border-bottom">
                            <div class="fw-bold small mb-1 text-dark">${k.title}</div>
                            <div class="small text-muted mb-2">${k.content.substring(0, 100)}${k.content.length > 100 ? '...' : ''}</div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-light text-muted border x-small-badge">${k.category}</span>
                                <small class="text-muted" style="font-size: 0.65rem;">${k.created_at ? new Date(k.created_at).toLocaleDateString() : ''}</small>
                            </div>
                        </div>
                    `;
                });
            }
            html += '</div></div>';
            
            html += '</div>';

        } else {
            // Vis√£o de Tabela Espec√≠fica
            const table = data.tables.find(t => t.table_name === selectedTable);
            if (!table) {
                container.innerHTML = '<div class="alert alert-warning mx-3">Tabela n√£o encontrada no cache.</div>';
                return;
            }

            const summaryMd = (table.deep_profile && table.deep_profile.summary_markdown) ? table.deep_profile.summary_markdown : (table.table_description || '### Sem resumo detalhado dispon√≠vel ainda.');

            html += `
                <div class="col-12 mb-4">
                    <div class="card border-0 shadow-sm overflow-hidden" style="border-radius: 15px;">
                        <div class="card-header bg-white p-4 border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                                        <i class="bi bi-table text-primary fs-4"></i>
                                    </div>
                                    <div>
                                        <h3 class="fw-bold text-dark mb-1">${table.table_name}</h3>
                                        <p class="text-muted mb-0 small">An√°lise de Intelig√™ncia de Dados</p>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="badge bg-primary px-3 py-2 fs-6 mb-1">${table.record_count.toLocaleString()} registros</div>
                                    <div class="small text-muted">√öltimo treino: ${formatDate(table.updated_at)}</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body p-4 markdown-body" style="background: #fff;">
                            ${formatMarkdown(summaryMd)}
                        </div>
                    </div>
                </div>
            `;

            // Filtrar padr√µes relacionados a esta tabela
            const tablePatterns = data.patterns.filter(p => 
                (p.table_name === selectedTable) ||
                (p.tags && p.tags.toLowerCase().includes(selectedTable.toLowerCase())) ||
                (p.category && p.category.toLowerCase().includes(selectedTable.toLowerCase()))
            );

            if (tablePatterns.length > 0) {
                html += `
                    <div class="col-12">
                        <div class="d-flex align-items-center mb-3">
                            <h5 class="fw-bold mb-0 text-dark">
                                <i class="bi bi-robot me-2 text-primary"></i>
                                Padr√µes Sem√¢nticos Relacionados
                            </h5>
                            <span class="badge bg-primary bg-opacity-10 text-primary ms-2">${tablePatterns.length}</span>
                        </div>
                        <div class="row g-3">
                `;
                tablePatterns.forEach((p, idx) => {
                    html += `
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm h-100" style="border-radius: 10px;">
                                <div class="card-body p-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="bg-primary bg-opacity-10 rounded p-1 me-2">
                                            <i class="bi bi-question-circle text-primary small"></i>
                                        </div>
                                        <div class="small fw-bold text-dark">Cen√°rio / Pergunta</div>
                                    </div>
                                    <div class="small mb-3 text-muted ps-4">${p.user_input}</div>
                                    
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="bg-success bg-opacity-10 rounded p-1 me-2">
                                            <i class="bi bi-check2-circle text-success small"></i>
                                        </div>
                                        <div class="small fw-bold text-dark">Resposta da IA</div>
                                    </div>
                                    <div class="p-2 bg-light rounded small text-muted ps-3 border-start border-success border-3">
                                        ${p.ai_response}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
        }

        container.innerHTML = html;
    }

    function toggleFullPattern(idx, base64Response) {
        const div = document.getElementById(`pattern-res-${idx}`);
        const btn = document.getElementById(`btn-pattern-${idx}`);
        const fullResponse = atob(base64Response);
        
        if (btn.innerHTML.includes('bi-plus-circle')) {
            div.innerText = fullResponse;
            btn.innerHTML = '<i class="bi bi-dash-circle me-1"></i>Recolher resposta';
        } else {
            div.innerText = fullResponse.substring(0, 120) + '...';
            btn.innerHTML = '<i class="bi bi-plus-circle me-1"></i>Ver resposta completa';
        }
    }

    // Carregar schemas dispon√≠veis
    async function loadSchemas() {
        console.log('Carregando schemas...');
        try {
            const response = await fetch('{{ url_for("config_rohden_ai_bp.get_schemas") }}');
            const data = await response.json();
            
            console.log('Resposta dos schemas:', data);
            
            availableSchemas = data.schemas || ['SYSROH', 'HDS'];
            
            const schemaSelect = document.getElementById('schemaSelect');
            schemaSelect.innerHTML = '<option value="">Selecione um schema...</option>';
            
            availableSchemas.forEach(schema => {
                const option = document.createElement('option');
                option.value = schema;
                option.textContent = schema;
                schemaSelect.appendChild(option);
            });
            
            // N√£o seleciona nenhum schema automaticamente
            currentSchema = '';
            schemaSelect.value = '';
            clearTablesLists();
            
        } catch (error) {
            console.error('Erro ao carregar schemas:', error);
            showNotification('Erro ao carregar schemas: ' + error.message, 'error');
            
            // Carrega schemas padr√£o em caso de erro
            availableSchemas = ['SYSROH', 'HDS'];
            const schemaSelect = document.getElementById('schemaSelect');
            schemaSelect.innerHTML = '<option value="">Selecione um schema...</option>';
            
            availableSchemas.forEach(schema => {
                const option = document.createElement('option');
                option.value = schema;
                option.textContent = schema;
                schemaSelect.appendChild(option);
            });
            
            currentSchema = '';
            schemaSelect.value = '';
            clearTablesLists();
        }
    }

    // Carregar tabelas para o schema selecionado
    async function loadTablesForSchema() {
        const schemaSelect = document.getElementById('schemaSelect');
        currentSchema = schemaSelect.value;
        
        console.log('Carregando tabelas para schema:', currentSchema);
        
        if (!currentSchema) {
            clearTablesLists();
            return;
        }
        
        // Mostrar loading
        showLoading();
        
        try {
            // Carregar tabelas do Oracle
            const response = await fetch(`/config_rohden_ai/get_tables_from_schema/${currentSchema}`);
            const data = await response.json();
            
            console.log('Resposta das tabelas:', data);
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            if (data.tables && Array.isArray(data.tables)) {
                allOracleTables = data.tables.map(table => ({
                    name: table,
                    schema: currentSchema
                }));
                console.log('Tabelas Oracle carregadas:', allOracleTables);
            } else {
                console.log('Nenhuma tabela encontrada');
                allOracleTables = [];
            }
            
            // Renderizar tabelas
            renderTables();
            
            // Garantir que a aba "Para Treinar" esteja selecionada ao trocar de schema
            const untrainedTab = document.getElementById('untrained-tab');
            if (untrainedTab && !untrainedTab.classList.contains('active')) {
                untrainedTab.click();
            }
            
        } catch (error) {
            console.error('Erro ao carregar tabelas do schema:', error);
            showNotification('Erro ao carregar tabelas: ' + error.message, 'error');
            allOracleTables = [];
            renderTables();
        }
    }

    function showLoading() {
        const trainedContainer = document.getElementById('trainedTablesList');
        const untrainedContainer = document.getElementById('untrainedTablesList');
        
        const loadingHtml = `
            <div class="loading-container">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
                <span class="ms-2">Carregando...</span>
            </div>
        `;
        
        trainedContainer.innerHTML = loadingHtml;
        untrainedContainer.innerHTML = loadingHtml;
    }

    function renderTables() {
        // Aba "Para Treinar" continua filtrada pelo schema selecionado
        const trainedTableNames = trainedTables.map(t => t.name);
        const untrainedTables = allOracleTables.filter(table => !trainedTableNames.includes(table.name));
        
        // Aba "Treinadas" agora mostra TUDO independente do schema
        console.log('Tabelas treinadas (todas):', trainedTables);
        console.log('Tabelas para treinar (schema atual):', untrainedTables);
        
        renderTrainedTables(trainedTables);
        renderUntrainedTables(untrainedTables);
    }

    function formatDate(dateStr) {
        if (!dateStr) return 'Data n√£o dispon√≠vel';
        try {
            // O SQLite retorna CURRENT_TIMESTAMP como "YYYY-MM-DD HH:MM:SS" em UTC
            // Para o JS interpretar como UTC, precisamos do formato ISO "YYYY-MM-DDTHH:MM:SSZ"
            const isoDate = dateStr.replace(' ', 'T') + 'Z';
            const date = new Date(isoDate);
            
            if (isNaN(date.getTime())) {
                // Tenta tratar como data local se falhar
                const localDate = new Date(dateStr);
                if (isNaN(localDate.getTime())) return dateStr;
                return localDate.toLocaleString('pt-BR');
            }
            
            return date.toLocaleString('pt-BR');
        } catch (e) {
            console.error('Erro ao formatar data:', dateStr, e);
            return dateStr;
        }
    }

    function renderTrainedTables(tables) {
        const container = document.getElementById('trainedTablesList');
        const searchTerm = document.getElementById('searchTrained').value.toLowerCase();
        
        const filteredTables = tables.filter(t => t.name.toLowerCase().includes(searchTerm));

        if (filteredTables.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4 w-100">
                    <i class="bi bi-info-circle text-muted" style="font-size: 2.5rem;"></i>
                    <p class="text-muted mt-2">Nenhuma tabela treinada encontrada</p>
                </div>
            `;
            return;
        }

        const html = filteredTables.map(table => {
            const dateStr = formatDate(table.updated_at);
            const schema = table.schema || 'SYSROH';
            const training = trainingStatusMap[table.name];
            const isTraining = training && !training.done;
            
            return `
                <div class="table-card trained-row" data-table="${table.name}" onclick="showTableDetails('${table.name}')" 
                     style="cursor: pointer; border-left: 4px solid ${isTraining ? '#17a2b8' : '#28a745'}; min-height: 100px;">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="table-name mb-1" style="font-size: 1rem; color: #2c3e50;">${table.name}</div>
                            <div class="small text-muted">
                                <span class="badge bg-light text-dark border me-1">${schema}</span>
                                <span class="badge ${isTraining ? 'bg-info text-white' : 'bg-success'} badge-status">
                                    ${isTraining ? `<span class="spinner-border spinner-border-sm me-1"></span>${training.percent}%` : 'TREINADA'}
                                </span>
                            </div>
                        </div>
                        <div class="d-flex gap-1">
                            ${isTraining ? '' : (!table.has_vector ? '<i class="bi bi-exclamation-triangle-fill text-warning" title="Sem Vetor"></i>' : '<i class="bi bi-check-circle-fill text-success" title="Vetor OK"></i>')}
                            ${isTraining ? '' : (table.export_status && table.export_status.startsWith('Erro') ? '<i class="bi bi-x-circle-fill text-danger" title="Erro Exporta√ß√£o"></i>' : '<i class="bi bi-cloud-check-fill text-info" title="Sincronizada"></i>')}
                        </div>
                    </div>
                    <div class="mt-auto d-flex justify-content-between align-items-center pt-2 border-top" style="font-size: 0.75rem;">
                        <span class="text-muted"><i class="bi bi-clock me-1"></i>${isTraining ? 'Treinando agora...' : dateStr}</span>
                        <span class="text-primary fw-bold">Ver detalhes <i class="bi bi-chevron-right"></i></span>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    }

    function renderUntrainedTables(tables) {
        const container = document.getElementById('untrainedTablesList');
        const searchTerm = document.getElementById('searchUntrained').value.toLowerCase();
        
        const filteredTables = tables.filter(t => t.name.toLowerCase().includes(searchTerm));

        if (filteredTables.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4 w-100">
                    <i class="bi bi-search text-muted" style="font-size: 2.5rem;"></i>
                    <p class="text-muted mt-2">Nenhuma tabela encontrada no schema ${currentSchema}</p>
                </div>
            `;
            return;
        }

        const html = filteredTables.map(table => {
            const training = trainingStatusMap[table.name];
            const isTraining = training && !training.done;
            
            return `
                <div class="table-card" data-table="${table.name}">
                    <div class="table-header">
                        <span class="table-name">${table.name}</span>
                        <span class="badge ${isTraining ? 'bg-info text-white' : 'bg-warning text-dark'} badge-status" style="font-size: 0.6rem;">
                            ${isTraining ? training.percent + '%' : 'PENDENTE'}
                        </span>
                    </div>
                    <div class="table-meta mb-2">
                        <i class="bi bi-diagram-2 me-1"></i>${table.schema}
                    </div>
                    <button class="btn ${isTraining ? 'btn-info disabled' : 'btn-primary'} btn-train" onclick="trainTable('${table.name}')">
                        ${isTraining ? `<span class="spinner-border spinner-border-sm me-1"></span>${training.percent}%` : '<i class="bi bi-play-fill me-1"></i>Treinar Tabela'}
                    </button>
                </div>
            `;
        }).join('');
        
        container.innerHTML = html;
    }

    function formatMarkdown(text) {
        if (!text) return '';
        
        try {
            // Se o marked estiver dispon√≠vel, usa ele para renderizar o Markdown completo
            if (window.marked) {
                return marked.parse(text);
            }
        } catch (e) {
            console.warn('Erro ao usar marked.js, usando fallback:', e);
        }
        
        // Fallback robusto se o marked falhar
        let formatted = text.replace(/### (.*)/g, '<h6 class="fw-bold mt-3 mb-2 text-primary border-bottom pb-1">$1</h6>');
        formatted = formatted.replace(/#### (.*)/g, '<div class="fw-bold mt-2 mb-1 text-dark small">$1</div>');
        formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong class="text-dark">$1</strong>');
        formatted = formatted.replace(/^- (.*)/gm, '<div class="ms-3 mb-1"><i class="bi bi-dot me-1"></i>$1</div>');
        
        if (formatted.includes('|')) {
            const lines = formatted.split('\n');
            let tableHtml = '<div class="table-responsive"><table class="table table-sm table-bordered mt-2 x-small-table"><tbody>';
            const processedLines = lines.map(line => {
                if (line.includes('|')) {
                    const cells = line.split('|').filter(c => c.trim().length > 0 || line.indexOf('|') !== line.lastIndexOf('|'));
                    if (cells.length > 0 && !line.includes('---')) {
                        return '<tr>' + cells.map(c => `<td>${c.trim()}</td>`).join('') + '</tr>';
                    }
                    return '';
                }
                return line;
            });
            formatted = processedLines.join('\n');
        }

        return formatted.replace(/\n/g, '<br>');
    }

    async function showTableDetails(tableName) {
        const table = trainedTables.find(t => t.name === tableName);
        if (!table) return;

        // Mostrar loading no modal ou buscar metadados se necess√°rio
        // Por enquanto vamos usar o que temos no trainedTables e tentar carregar metadados completos
        
        try {
            const response = await fetch('{{ url_for("config_rohden_ai_bp.get_current_config") }}?t=' + new Date().getTime());
            const data = await response.json();
            const meta = data.metadata[tableName];

            const modalHtml = `
                <div class="modal fade" id="tableDetailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-light">
                                <h5 class="modal-title fw-bold">
                                    <i class="bi bi-table me-2"></i>${tableName}
                                    <span class="badge bg-primary ms-2" style="font-size: 0.7rem;">${table.schema}</span>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-4">
                                    <div class="col-md-12">
                                        <h6 class="fw-bold text-muted small text-uppercase mb-2">Descri√ß√£o e Intelig√™ncia de Dados</h6>
                                        <div class="p-3 bg-white rounded border small shadow-sm markdown-body" style="max-height: 400px; overflow-y: auto; line-height: 1.5;">
                                            ${formatMarkdown(table.description) || 'Sem descri√ß√£o dispon√≠vel.'}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="stats-card p-3 mb-0" style="background: #f8f9fa; color: #333; border: 1px solid #dee2e6;">
                                            <div class="stats-number" style="font-size: 1.5rem; color: #0066cc;">${table.record_count}</div>
                                            <div class="stats-label text-muted">Registros Totais</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="stats-card p-3 mb-0" style="background: #f8f9fa; color: #333; border: 1px solid #dee2e6;">
                                            <div class="stats-number" style="font-size: 1.5rem; color: #28a745;">${meta ? meta.columns.length : 0}</div>
                                            <div class="stats-label text-muted">Colunas Mapeadas</div>
                                        </div>
                                    </div>
                                </div>

                                <ul class="nav nav-tabs" id="modalTabs" role="tablist">
                                    <li class="nav-item">
                                        <button class="nav-link active py-2" data-bs-toggle="tab" data-bs-target="#tab-columns">Colunas</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link py-2" data-bs-toggle="tab" data-bs-target="#tab-samples">Amostra</button>
                                    </li>
                                </ul>
                                <div class="tab-content border-top-0 p-3 bg-white border rounded-bottom">
                                    <div class="tab-pane fade show active" id="tab-columns">
                                        <div style="max-height: 300px; overflow-y: auto;">
                                            <table class="table table-sm table-hover small">
                                                <thead>
                                                    <tr>
                                                        <th>Coluna</th>
                                                        <th>Tipo</th>
                                                        <th>PK</th>
                                                        <th>Coment√°rio</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${meta ? meta.columns.map(c => `
                                                        <tr>
                                                            <td class="fw-bold">${c.name}</td>
                                                            <td><span class="badge bg-light text-dark border">${c.type}</span></td>
                                                            <td>${c.is_pk ? '<i class="bi bi-key-fill text-warning"></i>' : ''}</td>
                                                            <td class="text-muted">${c.comment || '-'}</td>
                                                        </tr>
                                                    `).join('') : '<tr><td colspan="4">Sem dados</td></tr>'}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="tab-samples">
                                        <div style="max-height: 300px; overflow-x: auto;">
                                            <table class="table table-sm table-hover small">
                                                <thead>
                                                    <tr>
                                                        ${meta && meta.samples.length > 0 ? Object.keys(meta.samples[0]).map(k => `<th>${k}</th>`).join('') : ''}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${meta ? meta.samples.slice(0, 5).map(row => `
                                                        <tr>
                                                            ${Object.values(row).map(v => `<td>${v}</td>`).join('')}
                                                        </tr>
                                                    `).join('') : '<tr><td>Sem amostras</td></tr>'}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer bg-light">
                                <button class="btn btn-outline-danger btn-sm" onclick="removeTable('${tableName}')">
                                    <i class="bi bi-trash me-1"></i>Remover Treinamento
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="trainTable('${tableName}')">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Retreinar Agora
                                </button>
                                <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Remover modal anterior se existir
            const oldModal = document.getElementById('tableDetailModal');
            if (oldModal) {
                const modalInstance = bootstrap.Modal.getInstance(oldModal);
                if (modalInstance) modalInstance.hide();
                oldModal.remove();
            }

            // Inserir e mostrar novo modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('tableDetailModal'));
            modal.show();

        } catch (error) {
            console.error('Erro ao carregar detalhes:', error);
            showNotification('Erro ao carregar detalhes da tabela', 'error');
        }
    }

    function filterUntrainedTables() {
        const trainedTableNames = trainedTables.map(t => t.name);
        const untrainedTables = allOracleTables.filter(table => !trainedTableNames.includes(table.name));
        renderUntrainedTables(untrainedTables);
    }

    function filterTrainedTables() {
        renderTrainedTables(trainedTables);
    }

    // Monitor global de progresso
    let trainingStatusMap = {};

    function startGlobalTrainingMonitor() {
        if (window.trainingMonitorInterval) return;
        
        window.trainingMonitorInterval = setInterval(async () => {
            const trainingTables = Object.keys(trainingStatusMap).filter(name => !trainingStatusMap[name].done);
            
            if (trainingTables.length === 0) {
                clearInterval(window.trainingMonitorInterval);
                window.trainingMonitorInterval = null;
                return;
            }

            for (const tableName of trainingTables) {
                try {
                    const resp = await fetch(`/config_rohden_ai/training_progress/${tableName}`);
                    const data = await resp.json();
                    
                    trainingStatusMap[tableName] = data;
                    
                    // Atualizar UI do card se vis√≠vel
                    const card = document.querySelector(`.table-card[data-table="${tableName}"]`);
                    if (card) {
                        const btn = card.querySelector('.btn-train');
                        const statusBadge = card.querySelector('.badge-status');
                        
                        if (data.done) {
                            if (statusBadge) {
                                statusBadge.className = 'badge bg-success badge-status';
                                statusBadge.innerText = card.classList.contains('trained-row') ? 'TREINADA' : 'CONCLU√çDO';
                            }
                            if (btn) {
                                btn.className = 'btn btn-success btn-train disabled';
                                btn.innerHTML = '<i class="bi bi-check-circle me-1"></i>Conclu√≠do';
                            }
                            // Recarregar listas ap√≥s conclus√£o
                            loadTables();
                        } else {
                            if (btn) {
                                btn.className = 'btn btn-info btn-train disabled';
                                btn.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span>${data.percent}%`;
                            }
                            if (statusBadge) {
                                statusBadge.className = 'badge bg-info text-white badge-status';
                                statusBadge.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span>${data.percent}%`;
                            }
                        }
                    }
                } catch (e) {
                    console.warn('Erro monitor:', e);
                }
            }
        }, 2000);
    }

    // Treinar tabela espec√≠fica
    async function trainTable(tableName) {
        console.log('Iniciando treinamento da tabela:', tableName);
        
        if (!confirm(`Deseja iniciar o treinamento da tabela ${tableName}? O processo ser√° executado em segundo plano.`)) {
            return;
        }

        try {
            const response = await fetch('/config_rohden_ai/process_table', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    table_name: tableName,
                    schema_name: currentSchema 
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showNotification(`Treinamento de ${tableName} iniciado!`, 'success');
                
                // Registrar no monitor
                trainingStatusMap[tableName] = { percent: 0, status: 'Iniciando...', done: false };
                startGlobalTrainingMonitor();
                
                // Atualizar UI do card imediatamente (Untrained ou Trained)
                const card = document.querySelector(`.table-card[data-table="${tableName}"]`);
                if (card) {
                    const btn = card.querySelector('.btn-train');
                    const badge = card.querySelector('.badge-status');
                    
                    if (btn) {
                        btn.className = 'btn btn-info btn-train disabled';
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>0%';
                    }
                    
                    if (badge) {
                        badge.className = 'badge bg-info text-white badge-status';
                        badge.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>0%';
                    }
                }
            } else {
                throw new Error(result.error || 'Erro ao iniciar treinamento');
            }
        } catch (error) {
            console.error('Erro ao treinar tabela:', error);
            showNotification('Erro: ' + error.message, 'error');
        }
    }

    // Remover tabela do treinamento
    async function removeTable(tableName) {
        if (!confirm(`Remover tabela ${tableName} do treinamento?`)) {
            return;
        }
        
        try {
            trainedTables = trainedTables.filter(t => t.name !== tableName);
            await saveTables();
            renderTables();
            showNotification('Tabela removida', 'success');
        } catch (error) {
            console.error('Erro ao remover tabela:', error);
            showNotification('Erro ao remover tabela: ' + error.message, 'error');
        }
    }

    // Carregar configura√ß√£o atual
    async function loadTables() {
        console.log('Buscando tabelas treinadas da API...');
        try {
            const response = await fetch('{{ url_for("config_rohden_ai_bp.get_current_config") }}?t=' + new Date().getTime());
            const data = await response.json();
            
            console.log('Tabelas treinadas carregadas da API:', data);
            
            if (data.tables) {
                trainedTables = data.tables.map(table => ({
                    ...table,
                    schema: table.schema || 'SYSROH'
                }));
                console.log('Vari√°vel trainedTables atualizada:', trainedTables);
            }
            
            // Renderizar sempre, independente de ter schema selecionado
            // (A lista de treinadas mostrar√° tudo, a de n√£o-treinadas mostrar√° nada se n√£o houver schema)
            renderTables();
            
        } catch (error) {
            console.error('Erro ao carregar configura√ß√£o de tabelas treinadas:', error);
        }
    }

    // Salvar tabelas
    async function saveTables() {
        try {
            const response = await fetch('{{ url_for("config_rohden_ai_bp.save_config") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tables: trainedTables })
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(result.error);
            }
        } catch (error) {
            throw error;
        }
    }

    function clearTablesLists() {
        // A lista de treinadas continua mostrando tudo
        renderTrainedTables(trainedTables);
        
        // A lista de n√£o-treinadas avisa para selecionar schema
        document.getElementById('untrainedTablesList').innerHTML = `
            <div class="text-center py-4 w-100">
                <i class="bi bi-diagram-2 text-muted" style="font-size: 2.5rem;"></i>
                <p class="text-muted mt-2">Selecione um schema para ver as tabelas dispon√≠veis para treinamento</p>
            </div>
        `;
    }

    // Upload de arquivos
    function setupUploadArea() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
    }

    async function handleFiles(files) {
        if (files.length === 0) return;
        
        const file = files[0];
        const maxSize = 10 * 1024 * 1024; // 10MB
        
        if (file.size > maxSize) {
            showNotification('Arquivo muito grande. M√°ximo 10MB.', 'error');
            return;
        }

        const validTypes = ['.xlsx', '.xls', '.csv'];
        const fileExt = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!validTypes.includes(fileExt)) {
            showNotification('Formato inv√°lido. Use .xlsx, .xls ou .csv', 'error');
            return;
        }

        await uploadFile(file);
    }

    async function uploadFile(file) {
        const uploadArea = document.getElementById('uploadArea');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const uploadStatus = document.getElementById('uploadStatus');

        uploadArea.classList.add('d-none');
        uploadProgress.classList.remove('d-none');

        try {
            // Simula√ß√£o de upload progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 30;
                if (progress > 90) progress = 90;
                
                progressBar.style.width = progress + '%';
                uploadStatus.textContent = `Processando... ${Math.round(progress)}%`;
            }, 500);

            setTimeout(() => {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                uploadStatus.textContent = 'Upload conclu√≠do!';
                
                uploadedFiles.push({
                    name: file.name,
                    size: file.size,
                    uploaded: new Date()
                });

                setTimeout(() => {
                    uploadArea.classList.remove('d-none');
                    uploadProgress.classList.add('d-none');
                    showNotification('Planilha carregada com sucesso!', 'success');
                }, 2000);
            }, 3000);

        } catch (error) {
            showNotification('Erro no upload: ' + error.message, 'error');
            uploadArea.classList.remove('d-none');
            uploadProgress.classList.add('d-none');
        }
    }

    // Carregar estat√≠sticas
    async function loadTrainingStats() {
        try {
            trainingStats = {
                totalTables: trainedTables.length,
                trainedTables: trainedTables.filter(t => t.processed).length,
                uploadedFiles: uploadedFiles.length,
                totalQueries: 0,
                accuracy: 0,
                lastUpdate: new Date()
            };

            // Carregar fluxos de processos
            const response = await fetch('{{ url_for("config_rohden_ai_bp.get_process_flows") }}');
            const flowData = await response.json();
            trainingStats.flows = flowData.flows || [];

            renderSummary();
        } catch (error) {
            console.error('Erro ao carregar estat√≠sticas:', error);
        }
    }

    function renderSummary() {
        const container = document.getElementById('summaryContent');
        
        let html = `
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-number">${trainingStats.totalTables}</div>
                        <div class="stats-label">Tabelas Configuradas</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-number">${trainingStats.trainedTables}</div>
                        <div class="stats-label">Tabelas Treinadas</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-number">${trainingStats.uploadedFiles}</div>
                        <div class="stats-label">Planilhas Carregadas</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-number">${trainingStats.totalQueries}</div>
                        <div class="stats-label">Consultas Realizadas</div>
                    </div>
                </div>
            </div>
        `;

        if (trainingStats.flows && trainingStats.flows.length > 0) {
            html += `
                <div class="row">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Fluxos de Processos Descobertos</h5>
                                <span class="badge bg-primary">Autom√°tico</span>
                            </div>
                            <div class="card-body">
                                ${trainingStats.flows.map(flow => `
                                    <div class="process-flow-item mb-4 p-3 border rounded bg-light">
                                        <h6 class="fw-bold text-primary mb-3">${flow.process_name}</h6>
                                        <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                                            ${flow.flow_sequence.map((step, idx) => `
                                                <div class="badge bg-white text-dark border p-2 shadow-sm">
                                                    <span class="text-muted me-1">${idx + 1}.</span> ${step}
                                                </div>
                                                ${idx < flow.flow_sequence.length - 1 ? '<i class="bi bi-arrow-right text-muted"></i>' : ''}
                                            `).join('')}
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <div class="small fw-bold text-muted mb-2">‚è±Ô∏è Regras de Timing:</div>
                                                <ul class="list-unstyled small">
                                                    ${flow.timing_insights.map(insight => `
                                                        <li class="mb-1">
                                                            <i class="bi bi-clock-history text-info me-2"></i>
                                                            ${insight.rule || insight.insight}
                                                        </li>
                                                    `).join('')}
                                                </ul>
                                            </div>
                                            <div class="col-md-6 border-start">
                                                <div class="small fw-bold text-muted mb-2">üìù Resumo do Ciclo:</div>
                                                <p class="small text-secondary mb-0">
                                                    ${flow.description || 'Ciclo de vida dos dados identificado automaticamente pela an√°lise de sequenciamento temporal.'}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="row">
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-diagram-3 text-muted" style="font-size: 3rem;"></i>
                        <p class="text-muted mt-3">Nenhum fluxo de processo identificado ainda.<br>Treine tabelas como TB_CONTATOS e TB_ORCAMENTO para descobrir fluxos.</p>
                    </div>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    async function saveTraining() {
        try {
            await saveTables();
            showNotification('Treinamento iniciado com sucesso!', 'success');
            // Mudar para aba de dados
            const dataTab = new bootstrap.Tab(document.getElementById('data-tab'));
            dataTab.show();
        } catch (error) {
            showNotification('Erro ao iniciar treinamento: ' + error.message, 'error');
        }
    }

    function showNotification(message, type) {
        // Criar elemento de notifica√ß√£o
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show`;
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';
        
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Remover ap√≥s 5 segundos
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
        
        console.log(`${type}: ${message}`);
    }
</script>

{% endblock %}